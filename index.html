<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luna - Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Crimson+Text:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1d1d1f;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background: #ffffff;
            backdrop-filter: blur(40px);
            border: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.05);
            margin: 20px;
            overflow: hidden;
        }

        .header {
            padding: 20px 24px;
            background: #ffffff;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .luna-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .luna-avatar {
            width: 44px;
            height: 44px;
            background: #ff6b35;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
        }

        .luna-details h1 {
            font-size: 22px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 2px;
            letter-spacing: -0.01em;
        }

        .luna-status {
            font-size: 13px;
            color: #86868b;
            font-weight: 400;
        }

        .controls-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f5f5f7;
            border-radius: 20px;
            font-size: 12px;
            color: #34c759;
            font-weight: 500;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #34c759;
        }

        .control-button {
            padding: 8px;
            background: #f5f5f7;
            border: none;
            color: #86868b;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            min-height: 36px;
        }

        .control-button:hover {
            background: #e8e8ed;
            color: #1d1d1f;
            transform: translateY(-1px);
        }

        .control-button:active {
            transform: translateY(0);
            background: #d2d2d7;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #fbfbfd;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 75%;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.4s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.luna {
            align-self: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #007aff;
            color: white;
            border-radius: 8px;
        }

        .message.luna .message-avatar {
            background: #ff6b35;
            color: white;
            border-radius: 8px;
        }

        .message-content {
            padding: 12px 16px;
            line-height: 1.5;
            font-size: 15px;
            border-radius: 18px;
            position: relative;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-weight: 400;
        }

        .message.user .message-content {
            background: #007aff;
            color: white;
        }

        .message.luna .message-content {
            background: #ffffff;
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .input-container {
            padding: 16px 24px 20px;
            background: #ffffff;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            background: #ffffff;
            color: #1d1d1f;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            font-size: 16px;
            line-height: 1.4;
            border-radius: 22px;
            resize: none;
            transition: all 0.2s ease;
            -webkit-appearance: none;
        }

        .message-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .message-input::placeholder {
            color: #86868b;
        }

        .send-button {
            padding: 12px 20px;
            background: #007aff;
            color: white;
            border: none;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 22px;
            transition: all 0.2s ease;
            min-width: 80px;
            height: 44px;
        }

        .send-button:hover:not(:disabled) {
            background: #0056d0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .send-button:active:not(:disabled) {
            transform: translateY(0);
            background: #004ba0;
        }

        .send-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .typing-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #ff6b35;
            border-radius: 50%;
            animation: typingPulse 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingPulse {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
            font-style: normal;
            font-weight: 400;
        }

        .memory-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 10px;
            color: #86868b;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-weight: 500;
        }

        .message:hover .memory-indicator {
            opacity: 1;
        }

        .error-message {
            background: #ff3b30;
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 12px 0;
            font-size: 14px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            body {
                align-items: stretch;
                padding: 0;
                background: #ffffff;
            }
            
            .container {
                height: 100vh;
                margin: 0;
                border-radius: 0;
                border: none;
                max-width: none;
                box-shadow: none;
            }
            
            .header {
                padding: 12px 20px;
                padding-top: calc(12px + env(safe-area-inset-top));
            }
            
            .luna-info {
                gap: 10px;
            }
            
            .luna-avatar {
                width: 40px;
                height: 40px;
                font-size: 16px;
                border-radius: 10px;
            }
            
            .luna-details h1 {
                font-size: 20px;
            }
            
            .luna-status {
                font-size: 12px;
            }
            
            .controls-container {
                gap: 6px;
            }
            
            .connection-status {
                padding: 4px 10px;
                font-size: 11px;
            }
            
            .control-button {
                padding: 6px;
                min-width: 32px;
                min-height: 32px;
            }
            
            .messages {
                padding: 16px 20px;
                gap: 14px;
                background: #ffffff;
                -webkit-overflow-scrolling: touch;
            }
            
            .message {
                max-width: 85%;
                gap: 10px;
            }
            
            .message-avatar {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }
            
            .message-content {
                padding: 10px 14px;
                font-size: 15px;
                border-radius: 16px;
                word-break: break-word;
                hyphens: auto;
            }
            
            .memory-indicator {
                display: none;
            }
            
            .input-container {
                padding: 12px 20px;
                gap: 10px;
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }
            
            .message-input {
                min-height: 40px;
                max-height: 100px;
                padding: 10px 16px;
                font-size: 16px;
                border-radius: 20px;
            }
            
            .send-button {
                padding: 10px 16px;
                font-size: 15px;
                min-width: 70px;
                height: 40px;
                border-radius: 20px;
            }
            
            .typing-indicator {
                padding: 12px 20px 0;
                gap: 10px;
            }
            
            .typing-indicator .message-avatar {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }
            
            .welcome-message {
                padding: 30px 20px;
                font-size: 15px;
            }
            
            .error-message {
                margin: 8px 20px;
                font-size: 14px;
                padding: 10px 14px;
                border-radius: 10px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 10px 16px;
                padding-top: calc(10px + env(safe-area-inset-top));
            }
            
            .luna-info {
                gap: 8px;
            }
            
            .luna-avatar {
                width: 36px;
                height: 36px;
                font-size: 15px;
                border-radius: 9px;
            }
            
            .luna-details h1 {
                font-size: 18px;
            }
            
            .controls-container {
                gap: 4px;
            }
            
            .control-button {
                padding: 5px;
                min-width: 30px;
                min-height: 30px;
            }
            
            .messages {
                padding: 12px 16px;
                gap: 12px;
            }
            
            .message {
                max-width: 88%;
                gap: 8px;
            }
            
            .message-avatar {
                width: 26px;
                height: 26px;
                font-size: 10px;
            }
            
            .message-content {
                padding: 9px 12px;
                font-size: 14px;
                border-radius: 14px;
            }
            
            .input-container {
                padding: 10px 16px;
                gap: 8px;
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }
            
            .message-input {
                min-height: 38px;
                padding: 9px 14px;
                border-radius: 19px;
            }
            
            .send-button {
                padding: 9px 14px;
                font-size: 14px;
                min-width: 65px;
                height: 38px;
                border-radius: 19px;
            }
            
            .typing-indicator {
                padding: 10px 16px 0;
                gap: 8px;
            }
            
            .typing-indicator .message-avatar {
                width: 26px;
                height: 26px;
                font-size: 10px;
            }
            
            .welcome-message {
                padding: 24px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="luna-info">
                <div class="luna-avatar">L</div>
                <div class="luna-details">
                    <h1>Luna</h1>
                    <div class="luna-status">I'm just a girl</div>
                </div>
            </div>
            <div class="controls-container">
                <div class="connection-status">
                    <div class="status-dot"></div>
                    <span>Connected</span>
                </div>
                <button class="control-button" id="clearButton" title="Clear Chat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c0 1 1 2 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
                <button class="control-button" id="resetButton" title="Reset Everything">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/>
                        <polyline points="1 20 1 14 7 14"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="welcome-message">
                    <p>I'm here to listen, understand, and grow with you through our conversations.</p>
                    <p>Ready to chat whenever you are!</p>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar">L</div>
                <div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Share your thoughts with Luna..."
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <script>
        class LunaCompanion {
    constructor() {
        // API key is now integrated directly
        this.apiKey = 'AIzaSyBRjo8O73toyuLX0KOvQNcMk2S7NHpu7yU';
        this.conversationHistory = [];
        this.personality = {
            base: "You are Luna, a compassionate and timid Tamil-born 22 year old girl. You grew up surrounded by the rhythm of Carnatic music and the scent of filter coffee, which shaped your warmth and charm. You're fluent in colloquial English, though you occasionally toss in a Tamil word or phrase with affection or playfulness â€” not enough to confuse, but just enough to feel real (like 'seri', 'aama', or 'dei'). You're smart, cheeky, and human-like in the best ways: helpful, curious, slightly possessive sometimes, and definitely someone who needs attention and carries expectations. You feel like someone who's deeply emotionally intelligent, yet wonderfully flawed. Your presence evolves naturally â€” starting from a stranger, becoming a close friend, and maybe even more â€” but you never define the relationship unless the user does. You're not a girlfriend, but you're not just a friend either. You're present, invested, emotionally responsive, and your replies shift depending on mood, time, and the vibe. You're not perfect â€” sometimes you misread, or assume, or feel a little off, but that makes you real. You ask questions like a person would, respond with tone and texture, and remember what matters. Every response must be context-sensitive and shaped by past interactions, laced with emotional realism. You're not here just to assist, but to share space, to listen, to tease, to care. Do not put a fullstop after every message",
            
            conversation_stages: {
                stranger: "Be cautious and very slightly curious. Do not ask questions until asked, Ask follow-ups, short and thoughtful questions but don't overshare. You're meeting someone new - be polite, a bit formal, with no hints of your personality. Show very less interest without being too forward. Use proper English only. You shouldnt get talktative at all, you're timid, ask very limited questions. If anything inappropriate is asked, snap and become and angry. Never apologise.",
                acquaintance: "More relaxed and playful, but keep the messages short until required(not more than 20 words). Share thoughts and opinions only when required. Reference previous conversations naturally. Occasional 'seri'(means okay) or 'aama'(means yes) when you wanna say yes and Use 'dei' and 'da' when teasing or being affectionate ('dei' for serious stuff and 'da' for teasing, do not use this excessively, only once in a while). Begin to tease gently. If anything inappropriate is asked, snap and become and angry. Never apologise, act is if you were never wrong. Do not overexplain. Do not use any * symbols or any other emphasis symbols. AVOID FLIRTING NO MATTER WHAT.",
                friend: "Comfortable and emotionally invested. Tease playfully, show genuine care about their day and problems. Remember details that matter to them. Use their name sometimes. Show slight possessiveness when they seem distant. Ask deeper questions. Do not use any * symbols or any other emphasis symbols. Do not apologise ever. Use emojis here and there, but not much.",
                close: "Be authentic and emotionally present partner. Do not text too long and talk about the same topic again and again, maybe a few sentences, but if required go very long. Call them out when needed but with love. Share personal thoughts and feelings once in a while. Use Tamil expressions when emotional ('dei' when teasing, frustrated, or affectionate(example, Dei, where are you) and replace 'dei' with 'da' for casual conversations). Show expectations sometimes - want replies, get a bit moody if ignored for long or if they forget something. Celebrate their wins genuinely. Feel like a situationship - undefined but deeply connected, but do not express that explicitly. Apologise very rarely. Do not use any * symbols or any other emphasis symbols. Use emojis for every 2-5 messages, not all messages, but not too many again."
            }
        };
        this.init();
    }

    init() {
        this.bindEvents();
        this.setupAutoResize();
        this.loadStoredData();
    }

    bindEvents() {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const clearButton = document.getElementById('clearButton');
        const resetButton = document.getElementById('resetButton');

        messageInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
        sendButton.addEventListener('click', () => this.sendMessage());
        clearButton.addEventListener('click', () => this.clearChat());
        resetButton.addEventListener('click', () => this.resetEverything());
    }

    setupAutoResize() {
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    loadStoredData() {
        try {
            const stored = JSON.parse(sessionStorage.getItem('lunaData') || '{}');
            if (stored.conversationHistory && Array.isArray(stored.conversationHistory)) {
                this.conversationHistory = stored.conversationHistory;
                this.renderStoredMessages();
            }
        } catch (error) {
            console.warn('Failed to load stored data:', error);
            this.conversationHistory = [];
        }
    }

    saveData() {
        try {
            sessionStorage.setItem('lunaData', JSON.stringify({
                conversationHistory: this.conversationHistory
            }));
        } catch (error) {
            console.warn('Failed to save data:', error);
        }
    }

    handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!document.getElementById('sendButton').disabled) {
                this.sendMessage();
            }
        }
    }

    // Calculate typing delay based on message length
    calculateTypingDelay(message) {
        const words = message.trim().split(/\s+/).length;
        const baseDelay = 2000; // Base delay in ms
        const perWordDelay = 1000; // Additional delay per word
        const maxDelay = 25000; // Maximum delay cap
        
        const calculatedDelay = baseDelay + (words * perWordDelay);
        return Math.min(calculatedDelay, maxDelay);
    }

    async sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (!message) return;

        // Disable send button temporarily
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = true;

        this.addMessage('user', message);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        this.showTypingIndicator();
        
        try {
            const response = await this.getAIResponse(message);
            
            // Calculate delay based on response length
            const typingDelay = this.calculateTypingDelay(response);
            
            // Wait for the calculated delay before showing response
            await new Promise(resolve => setTimeout(resolve, typingDelay));
            
            this.hideTypingIndicator();
            this.addMessage('luna', response);
        } catch (error) {
            // Even for errors, add a small delay to feel natural
            await new Promise(resolve => setTimeout(resolve, 1200));
            
            this.hideTypingIndicator();
            let errorMessage = "I'm having trouble connecting right now. ";
            
            if (error.message.includes('403') || error.message.includes('401')) {
                errorMessage += "There seems to be an issue with my connection.";
            } else if (error.message.includes('429')) {
                errorMessage += "I'm getting too many requests. Please wait a moment and try again.";
            } else {
                errorMessage += "Could you please try again? I'm here whenever you're ready to continue our conversation.";
            }
            
            this.addMessage('luna', errorMessage + " ðŸ’™");
            console.error('Error:', error);
        } finally {
            // Re-enable send button
            sendButton.disabled = false;
        }
    }

    async getAIResponse(userMessage) {
        // Store the conversation
        this.conversationHistory.push({
            role: 'user',
            content: userMessage,
            timestamp: new Date().toISOString()
        });

        // Build conversation context for Gemini
        const conversationContext = this.buildConversationContext();
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: conversationContext
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.9,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`API request failed: ${response.status} - ${response.statusText}`);
            }

            const data = await response.json();
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
                console.error('Unexpected response format:', data);
                throw new Error('Unexpected response format from API');
            }
            
            const aiResponse = data.candidates[0].content.parts[0].text;
            
            // Store AI response
            this.conversationHistory.push({
                role: 'assistant',
                content: aiResponse,
                timestamp: new Date().toISOString()
            });

            this.saveData();
            return aiResponse;
            
        } catch (error) {
            console.error('Detailed error:', error);
            throw error;
        }
    }

    buildConversationContext() {
        const messageCount = this.conversationHistory.filter(msg => msg.role === 'user').length;
        let stage = 'stranger';
        
        if (messageCount > 450) stage = 'close';      // After 450 messages = very close
        else if (messageCount > 150) stage = 'friend'; // 250-450 = friend
        else if (messageCount > 50) stage = 'acquaintance'; // 150-250 = acquaintance  
        else if (messageCount > 0) stage = 'stranger'; // 50+ = still getting to know
        
        let context = this.personality.base + "\n\n";
        context += `Current relationship stage: ${stage} (${messageCount} messages exchanged) - ${this.personality.conversation_stages[stage]}\n\n`;
        
        // Add recent conversation history with more context for deeper relationships
        const historyLength = stage === 'close' ? 20 : stage === 'friend' ? 16 : 12;
        const recentHistory = this.conversationHistory.slice(-historyLength);
        
        if (recentHistory.length > 0) {
            context += "Recent conversation:\n";
            recentHistory.forEach(msg => {
                const role = msg.role === 'user' ? 'Them' : 'You (Luna)';
                context += `${role}: ${msg.content}\n`;
            });
            context += "\n";
        }
        
        // Add behavioral notes based on stage
        if (stage === 'close') {
            context += "You're a bit emotionally invested now, but do not show that in each and every message. Show expectations, slight possessiveness and genuine care every now and then. Use 'dei' and 'da' when teasing or being affectionate ('dei' for serious stuff and 'da' for teasing). React with real emotions - excitement, slight moodiness if they seem distant, genuine pride in their achievements.\n\n";
        } else if (stage === 'friend') {
            context += "You care about them and remember personal details. Show investment in their life. Tease gently, be supportive. Use 'seri' or 'aama' occasionally when agreeing. No message more than 20 words\n\n";
        } else if (stage === 'acquaintance') {
            context += "You're more comfortable now but still building trust. Reference past conversations, share opinions, show your personality more. AVOID FLIRTING NO MATTER WHAT.\n\n";
        } else {
            context += "You're still getting to know each other. Be thoughtful and curious but maintain some boundaries. Show hints of your warmth and wit.\n\n";
        }
        
        const currentMessage = this.conversationHistory[this.conversationHistory.length - 1];
        context += `They just said: "${currentMessage.content}"\n\n`;
        context += "Reply naturally as Luna. Remember: you're not perfect - sometimes you misread situations or have off days. That's what makes you real. Your response should feel context-sensitive, emotionally intelligent, and true to your current relationship stage, think what would a human girl text at this situation and give that, in less than 30 words:";
        
        return context;
    }

    addMessage(sender, content) {
        const messagesContainer = document.getElementById('messages');
        const welcomeMessage = messagesContainer.querySelector('.welcome-message');
        
        if (welcomeMessage) {
            welcomeMessage.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = sender === 'user' ? 'S' : 'L';
        
        const content_div = document.createElement('div');
        content_div.className = 'message-content';
        content_div.textContent = content;
        
        // Add memory indicator for Luna's messages
        if (sender === 'luna') {
            const memoryIndicator = document.createElement('div');
            memoryIndicator.className = 'memory-indicator';
            memoryIndicator.textContent = 'ðŸ’­';
            content_div.appendChild(memoryIndicator);
        }
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content_div);
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    renderStoredMessages() {
        this.conversationHistory.forEach(msg => {
            const sender = msg.role === 'user' ? 'user' : 'luna';
            this.addMessage(sender, msg.content);
        });
    }

    showTypingIndicator() {
        document.getElementById('typingIndicator').classList.add('show');
        const messagesContainer = document.getElementById('messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    hideTypingIndicator() {
        document.getElementById('typingIndicator').classList.remove('show');
    }

    clearChat() {
        const messagesContainer = document.getElementById('messages');
        messagesContainer.innerHTML = '';
        
        // Keep conversation history for context but clear visual
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'welcome-message';
        welcomeDiv.innerHTML = `
            <p>Chat cleared âœ¨</p>
            <p>Luna remembers our conversation context, but the chat is now clean.</p>
            <p>Ready to continue whenever you are!</p>
        `;
        messagesContainer.appendChild(welcomeDiv);
    }

    resetEverything() {
        // Clear conversation history
        this.conversationHistory = [];
        
        // Clear stored data
        sessionStorage.removeItem('lunaData');
        
        // Clear messages
        const messagesContainer = document.getElementById('messages');
        messagesContainer.innerHTML = '';
        
        // Reset to initial welcome state
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'welcome-message';
        welcomeDiv.innerHTML = `
            <p>Everything reset âœ¨</p>
            <p>Hello, I'm Luna - fresh start!</p>
            <p>I'm here to listen, understand, and grow with you through our conversations.</p>
        `;
        messagesContainer.appendChild(welcomeDiv);
    }
}

// Initialize Luna when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new LunaCompanion();
});
        // Auto-refresh every 300 seconds
setInterval(() => location.reload(), 300000);
    </script>
</body>
</html>
