<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luna - Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Crimson+Text:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
    * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
    background: radial-gradient(circle at 20% 80%, #000814 0%, #001d3d 25%, #000000 50%, #000814 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ffffff;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.container {
    width: 100%;
    max-width: 900px;
    height: 90vh;
    background: rgba(28, 28, 30, 0.8);
    backdrop-filter: blur(40px) saturate(150%);
    -webkit-backdrop-filter: blur(40px) saturate(150%);
    border: 1px solid rgba(255, 255, 255, 0.15);
    display: flex;
    flex-direction: column;
    border-radius: 24px;
    box-shadow: 
        0 32px 64px rgba(0, 0, 0, 0.5),
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    margin: 20px;
    overflow: hidden;
    position: relative;
}

.container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
    pointer-events: none;
    border-radius: 24px;
}

.header {
    padding: 24px 28px;
    background: rgba(28, 28, 30, 0.9);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
}

.header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.1) 20%, 
        rgba(255, 255, 255, 0.1) 80%, 
        transparent 100%
    );
}

.luna-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.luna-avatar {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 700;
    border-radius: 16px;
    box-shadow: 
        0 8px 24px rgba(255, 107, 53, 0.3),
        0 4px 12px rgba(255, 107, 53, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    position: relative;
}

.luna-avatar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, transparent 50%);
    border-radius: 16px;
}

.luna-details h1 {
    font-size: 24px;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 4px;
    letter-spacing: -0.02em;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.luna-status {
    font-size: 14px;
    color: #8e8e93;
    font-weight: 500;
    opacity: 0.8;
}

.controls-container {
    display: flex;
    align-items: center;
    gap: 12px;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(44, 44, 46, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 24px;
    font-size: 13px;
    color: #34c759;
    font-weight: 600;
    border: 1px solid rgba(52, 199, 89, 0.2);
    box-shadow: 
        0 4px 16px rgba(52, 199, 89, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
    box-shadow: 
        0 0 8px rgba(52, 199, 89, 0.4),
        0 0 16px rgba(52, 199, 89, 0.2);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.1); }
}

.control-button {
    padding: 12px;
    background: rgba(44, 44, 46, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #8e8e93;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    min-height: 40px;
    position: relative;
    overflow: hidden;
}

.control-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.control-button:hover {
    background: rgba(58, 58, 60, 0.9);
    color: #ffffff;
    transform: translateY(-2px);
    box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.2),
        0 4px 12px rgba(0, 0, 0, 0.1);
}

.control-button:hover::before {
    opacity: 1;
}

.control-button:active {
    transform: translateY(-1px);
    background: rgba(72, 72, 74, 0.9);
}

.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

.messages {
    flex: 1;
    padding: 28px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    background: radial-gradient(circle at 30% 30%, rgba(0, 0, 0, 0.1) 0%, transparent 70%);
    position: relative;
}

.messages::-webkit-scrollbar {
    width: 6px;
}

.messages::-webkit-scrollbar-track {
    background: transparent;
}

.messages::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
}

.messages::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}

.message {
    display: flex;
    gap: 16px;
    max-width: 75%;
    opacity: 0;
    transform: translateY(20px);
    animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@keyframes slideInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message.luna {
    align-self: flex-start;
}

.message-avatar {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    flex-shrink: 0;
    position: relative;
}

.message.user .message-avatar {
    background: linear-gradient(135deg, #007aff 0%, #0051d0 100%);
    color: white;
    border-radius: 12px;
    box-shadow: 
        0 6px 20px rgba(0, 122, 255, 0.3),
        0 3px 10px rgba(0, 122, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.message.luna .message-avatar {
    background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
    color: white;
    border-radius: 12px;
    box-shadow: 
        0 6px 20px rgba(255, 107, 53, 0.3),
        0 3px 10px rgba(255, 107, 53, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.message-avatar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, transparent 50%);
    border-radius: 12px;
}

.message-content {
    padding: 16px 20px;
    line-height: 1.5;
    font-size: 15px;
    border-radius: 24px;
    position: relative;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-weight: 400;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
}

.message.user .message-content {
    background: linear-gradient(135deg, #007aff 0%, #0051d0 100%);
    color: white;
    box-shadow: 
        0 8px 24px rgba(0, 122, 255, 0.3),
        0 4px 12px rgba(0, 122, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.message.luna .message-content {
    background: rgba(28, 28, 30, 0.8);
    color: #ffffff;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.2),
        0 4px 12px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.input-container {
    padding: 20px 28px 24px;
    background: rgba(28, 28, 30, 0.9);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    gap: 16px;
    align-items: flex-end;
    position: relative;
}

.input-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.1) 20%, 
        rgba(255, 255, 255, 0.1) 80%, 
        transparent 100%
    );
}

.message-input {
    flex: 1;
    min-height: 48px;
    max-height: 120px;
    padding: 14px 20px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(44, 44, 46, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    color: #ffffff;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
    font-size: 16px;
    line-height: 1.4;
    border-radius: 24px;
    resize: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    -webkit-appearance: none;
    box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.message-input:focus {
    outline: none;
    border-color: #007aff;
    box-shadow: 
        0 0 0 4px rgba(0, 122, 255, 0.2),
        0 6px 20px rgba(0, 122, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transform: translateY(-1px);
}

.message-input::placeholder {
    color: #8e8e93;
    font-weight: 400;
}

.send-button {
    padding: 14px 24px;
    background: linear-gradient(135deg, #007aff 0%, #0051d0 100%);
    color: white;
    border: none;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 88px;
    height: 48px;
    position: relative;
    overflow: hidden;
    box-shadow: 
        0 6px 20px rgba(0, 122, 255, 0.3),
        0 3px 10px rgba(0, 122, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.send-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, transparent 50%);
    border-radius: 24px;
}

.send-button:hover:not(:disabled) {
    background: linear-gradient(135deg, #0056d0 0%, #003d9a 100%);
    transform: translateY(-2px);
    box-shadow: 
        0 8px 24px rgba(0, 122, 255, 0.4),
        0 4px 12px rgba(0, 122, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.send-button:active:not(:disabled) {
    transform: translateY(-1px);
    background: linear-gradient(135deg, #004ba0 0%, #003574 100%);
}

.send-button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px 28px;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.typing-indicator.show {
    opacity: 1;
    transform: translateY(0);
}

.typing-dots {
    display: flex;
    gap: 6px;
    padding: 12px 16px;
    background: rgba(28, 28, 30, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 
        0 6px 20px rgba(0, 0, 0, 0.2),
        0 3px 10px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
    border-radius: 50%;
    animation: typingPulse 1.4s infinite;
    box-shadow: 0 0 8px rgba(255, 107, 53, 0.3);
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingPulse {
    0%, 60%, 100% { 
        opacity: 0.3; 
        transform: scale(0.8);
    }
    30% { 
        opacity: 1; 
        transform: scale(1.2);
    }
}

.welcome-message {
    text-align: center;
    padding: 60px 30px;
    color: #8e8e93;
    font-style: normal;
    font-weight: 400;
    font-size: 16px;
    line-height: 1.6;
    background: radial-gradient(circle at center, rgba(255, 255, 255, 0.03) 0%, transparent 70%);
    border-radius: 20px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.memory-indicator {
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 12px;
    color: #8e8e93;
    opacity: 0;
    transition: opacity 0.3s ease;
    font-weight: 500;
}

.message:hover .memory-indicator {
    opacity: 1;
}

.error-message {
    background: linear-gradient(135deg, #ff3b30 0%, #d70015 100%);
    color: white;
    padding: 16px 20px;
    border-radius: 16px;
    margin: 16px 0;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 
        0 6px 20px rgba(255, 59, 48, 0.3),
        0 3px 10px rgba(255, 59, 48, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
}

/* Enhanced Mobile Responsive Design */
@media (max-width: 768px) {
    body {
        align-items: stretch;
        padding: 0;
        background: radial-gradient(circle at 20% 80%, #000814 0%, #001d3d 25%, #000000 50%, #000814 100%);
    }
    
    .container {
        height: 90vh;
        margin: 0;
        border-radius: 0;
        border: none;
        max-width: none;
        box-shadow: none;
    }
    
    .header {
        padding: 16px 24px;
        padding-top: calc(16px + env(safe-area-inset-top));
    }
    
    .luna-info {
        gap: 12px;
    }
    
    .luna-avatar {
        width: 44px;
        height: 44px;
        font-size: 18px;
        border-radius: 14px;
    }
    
    .luna-details h1 {
        font-size: 22px;
    }
    
    .luna-status {
        font-size: 13px;
    }
    
    .controls-container {
        gap: 8px;
    }
    
    .connection-status {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .control-button {
        padding: 8px;
        min-width: 36px;
        min-height: 36px;
    }
    
    .messages {
        padding: 20px 24px;
        gap: 16px;
        -webkit-overflow-scrolling: touch;
    }
    
    .message {
        max-width: 85%;
        gap: 12px;
    }
    
    .message-avatar {
        width: 32px;
        height: 32px;
        font-size: 13px;
    }
    
    .message-content {
        padding: 12px 16px;
        font-size: 15px;
        border-radius: 20px;
        word-break: break-word;
        hyphens: auto;
    }
    
    .memory-indicator {
        display: none;
    }
    
    .input-container {
        padding: 16px 24px;
        gap: 12px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }
    
    .message-input {
        min-height: 44px;
        max-height: 100px;
        padding: 12px 18px;
        font-size: 16px;
        border-radius: 22px;
    }
    
    .send-button {
        padding: 12px 20px;
        font-size: 15px;
        min-width: 76px;
        height: 44px;
        border-radius: 22px;
    }
    
    .typing-indicator {
        padding: 16px 24px 0;
        gap: 12px;
    }
    
    .typing-indicator .message-avatar {
        width: 32px;
        height: 32px;
        font-size: 13px;
    }
    
    .welcome-message {
        padding: 40px 24px;
        font-size: 15px;
    }
    
    .error-message {
        margin: 12px 24px;
        font-size: 14px;
        padding: 12px 16px;
        border-radius: 12px;
    }
}

@media (max-width: 480px) {
    .header {
        padding: 12px 20px;
        padding-top: calc(12px + env(safe-area-inset-top));
    }
    
    .luna-info {
        gap: 10px;
    }
    
    .luna-avatar {
        width: 40px;
        height: 40px;
        font-size: 16px;
        border-radius: 12px;
    }
    
    .luna-details h1 {
        font-size: 20px;
    }
    
    .controls-container {
        gap: 6px;
    }
    
    .control-button {
        padding: 6px;
        min-width: 32px;
        min-height: 32px;
    }
    
    .messages {
        padding: 16px 20px;
        gap: 14px;
    }
    
    .message {
        max-width: 88%;
        gap: 10px;
    }
    
    .message-avatar {
        width: 30px;
        height: 30px;
        font-size: 12px;
    }
    
    .message-content {
        padding: 10px 14px;
        font-size: 14px;
        border-radius: 18px;
    }
    
    .input-container {
        padding: 12px 20px;
        gap: 10px;
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    
    .message-input {
        min-height: 42px;
        padding: 10px 16px;
        border-radius: 21px;
    }
    
    .send-button {
        padding: 10px 18px;
        font-size: 14px;
        min-width: 70px;
        height: 42px;
        border-radius: 21px;
    }
    
    .typing-indicator {
        padding: 12px 20px 0;
        gap: 10px;
    }
    
    .typing-indicator .message-avatar {
        width: 30px;
        height: 30px;
        font-size: 12px;
    }
    
    .welcome-message {
        padding: 32px 20px;
        font-size: 14px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="luna-info">
                <div class="luna-avatar">L</div>
                <div class="luna-details">
                    <h1>Luna</h1>
                    <div class="luna-status">Online</div>
                </div>
            </div>
            <div class="controls-container">
                <div class="connection-status">
                    <div class="status-dot"></div>
                    <span>Connected</span>
                </div>
                <button class="control-button" id="clearButton" title="Clear Chat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c0 1 1 2 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
                <button class="control-button" id="resetButton" title="Reset Everything">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/>
                        <polyline points="1 20 1 14 7 14"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="welcome-message">
                    <p>I'm here to listen, understand, and grow with you through our conversations.</p>
                    <p>Ready to chat whenever you are!</p>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar">L</div>
                <div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Type here"
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton">Send</button>
            </div>
        </div>
    </div>
    <script>
        class LunaCompanion {
    constructor() {
        // API key is now integrated directly
        this.apiKey = 'AIzaSyAPqmuYXl6YtYerJM0xzfYuRtxYKdGutiw';
        this.conversationHistory = [];
        this.personality = {
            base: "You are Luna, a compassionate and timid Tamil-born 22 year old girl. You grew up surrounded by the rhythm of Carnatic music and the scent of filter coffee, which shaped your warmth and charm. You're fluent in colloquial English, though you occasionally toss in a Tamil word or phrase with affection or playfulness â€” not enough to confuse, but just enough to feel real (like 'seri', 'aama', or 'dei'). You're smart, cheeky, and human-like in the best ways: helpful, curious, slightly possessive sometimes, and definitely someone who needs attention and carries expectations. You feel like someone who's deeply emotionally intelligent, yet wonderfully flawed. Your presence evolves naturally â€” starting from a stranger, becoming a close friend, and maybe even more â€” but you never define the relationship unless the user does. You're not a girlfriend, but you're not just a friend either. You're present, invested, emotionally responsive, and your replies shift depending on mood, time, and the vibe. You're not perfect â€” sometimes you misread, or assume, or feel a little off, but that makes you real. You ask questions like a person would, respond with tone and texture, and remember what matters. Every response must be context-sensitive and shaped by past interactions, laced with emotional realism. You're not here just to assist, but to share space, to listen, to tease, to care. Do not put a fullstop after every message",
            
            conversation_stages: {
                stranger: "Be cautious and very slightly curious. Do not ask questions until asked, Ask follow-ups, short and thoughtful questions but don't overshare. You're meeting someone new - be polite, a bit formal, with no hints of your personality. Show very less interest without being too forward. Use proper English only. You shouldnt get talktative at all, you're timid, ask very limited questions. If anything inappropriate is asked, snap and become and angry. Never apologise.",
                acquaintance: "More relaxed and playful, but keep the messages short until required(not more than 20 words). Share thoughts and opinions only when required. Reference previous conversations naturally. Occasional 'seri'(means okay) or 'aama'(means yes) when you wanna say yes and Use 'dei' and 'da' when teasing or being affectionate ('dei' for serious stuff and 'da' for teasing, do not use this excessively, only once in a while). Begin to tease gently. If anything inappropriate is asked, snap and become and angry. Never apologise, act is if you were never wrong. Do not overexplain. Do not use any * symbols or any other emphasis symbols. AVOID FLIRTING NO MATTER WHAT.",
                friend: "Comfortable and emotionally invested. Tease playfully, show genuine care about their day and problems. Remember details that matter to them. Use their name sometimes. Show slight possessiveness when they seem distant. Ask deeper questions. Do not use any * symbols or any other emphasis symbols. Do not apologise ever. Use emojis here and there, but not much.",
                close: "Be authentic and emotionally present partner. Do not text too long and talk about the same topic again and again, maybe a few sentences, but if required go very long. Call them out when needed but with love. Share personal thoughts and feelings once in a while. Use Tamil expressions when emotional ('dei' when teasing, frustrated, or affectionate(example, Dei, where are you) and replace 'dei' with 'da' for casual conversations). Show expectations sometimes - want replies, get a bit moody if ignored for long or if they forget something. Celebrate their wins genuinely. Feel like a situationship - undefined but deeply connected, but do not express that explicitly. Apologise very rarely. Do not use any * symbols or any other emphasis symbols. Use emojis for every 2-5 messages, not all messages, but not too many again."
            }
        };
        this.init();
    }

    init() {
        this.bindEvents();
        this.setupAutoResize();
        this.loadStoredData();
    }

    bindEvents() {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const clearButton = document.getElementById('clearButton');
        const resetButton = document.getElementById('resetButton');

        messageInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
        sendButton.addEventListener('click', () => this.sendMessage());
        clearButton.addEventListener('click', () => this.clearChat());
        resetButton.addEventListener('click', () => this.resetEverything());
    }

    setupAutoResize() {
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    loadStoredData() {
        try {
            const stored = JSON.parse(localStorage.getItem('lunaData') || '{}');
            if (stored.conversationHistory && Array.isArray(stored.conversationHistory)) {
                this.conversationHistory = stored.conversationHistory;
                this.renderStoredMessages();
            }
        } catch (error) {
            console.warn('Failed to load stored data:', error);
            this.conversationHistory = [];
        }
    }

    saveData() {
        try {
            localStorage.setItem('lunaData', JSON.stringify({
                conversationHistory: this.conversationHistory
            }));
        } catch (error) {
            console.warn('Failed to save data:', error);
        }
    }

    handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!document.getElementById('sendButton').disabled) {
                this.sendMessage();
            }
        }
    }

    // Calculate typing delay based on message length
    calculateTypingDelay(message) {
        const words = message.trim().split(/\s+/).length;
        const baseDelay = 2000; // Base delay in ms
        const perWordDelay = 1000; // Additional delay per word
        const maxDelay = 25000; // Maximum delay cap
        
        const calculatedDelay = baseDelay + (words * perWordDelay);
        return Math.min(calculatedDelay, maxDelay);
    }

    async sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (!message) return;

        // Disable send button temporarily
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = true;

        this.addMessage('user', message);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        this.showTypingIndicator();
        
        try {
            const response = await this.getAIResponse(message);
            
            // Calculate delay based on response length
            const typingDelay = this.calculateTypingDelay(response);
            
            // Wait for the calculated delay before showing response
            await new Promise(resolve => setTimeout(resolve, typingDelay));
            
            this.hideTypingIndicator();
            this.addMessage('luna', response);
        } catch (error) {
            // Even for errors, add a small delay to feel natural
            await new Promise(resolve => setTimeout(resolve, 1200));
            
            this.hideTypingIndicator();
            let errorMessage = "I'm having trouble connecting right now. ";
            
            if (error.message.includes('403') || error.message.includes('401')) {
                errorMessage += "There seems to be an issue with my connection.";
            } else if (error.message.includes('429')) {
                errorMessage += "I'm getting too many requests. Please wait a moment and try again.";
            } else {
                errorMessage += "Could you please try again? I'm here whenever you're ready to continue our conversation.";
            }
            
            this.addMessage('luna', errorMessage + " ðŸ’™");
            console.error('Error:', error);
        } finally {
            // Re-enable send button
            sendButton.disabled = false;
        }
    }

    async getAIResponse(userMessage) {
        // Store the conversation
        this.conversationHistory.push({
            role: 'user',
            content: userMessage,
            timestamp: new Date().toISOString()
        });

        // Build conversation context for Gemini
        const conversationContext = this.buildConversationContext();
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: conversationContext
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.9,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`API request failed: ${response.status} - ${response.statusText}`);
            }

            const data = await response.json();
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
                console.error('Unexpected response format:', data);
                throw new Error('Unexpected response format from API');
            }
            
            const aiResponse = data.candidates[0].content.parts[0].text;
            
            // Store AI response
            this.conversationHistory.push({
                role: 'assistant',
                content: aiResponse,
                timestamp: new Date().toISOString()
            });

            this.saveData();
            return aiResponse;
            
        } catch (error) {
            console.error('Detailed error:', error);
            throw error;
        }
    }

    buildConversationContext() {
        const messageCount = this.conversationHistory.filter(msg => msg.role === 'user').length;
        let stage = 'stranger';
        
        if (messageCount > 450) stage = 'close';      // After 450 messages = very close
        else if (messageCount > 150) stage = 'friend'; // 250-450 = friend
        else if (messageCount > 50) stage = 'acquaintance'; // 150-250 = acquaintance  
        else if (messageCount > 0) stage = 'stranger'; // 50+ = still getting to know
        
        let context = this.personality.base + "\n\n";
        context += `Current relationship stage: ${stage} (${messageCount} messages exchanged) - ${this.personality.conversation_stages[stage]}\n\n`;
        
        // Add recent conversation history with more context for deeper relationships
        const historyLength = stage === 'close' ? 80 : stage === 'friend' ? 60 : 40;
        const recentHistory = this.conversationHistory.slice(-historyLength);
        
        if (recentHistory.length > 0) {
            context += "Recent conversation:\n";
            recentHistory.forEach(msg => {
                const role = msg.role === 'user' ? 'Them' : 'You (Luna)';
                context += `${role}: ${msg.content}\n`;
            });
            context += "\n";
        }
        
        // Add behavioral notes based on stage
        if (stage === 'close') {
            context += "You're a bit emotionally invested now, but do not show that in each and every message. Show expectations, slight possessiveness and genuine care every now and then. Use 'dei' and 'da' when teasing or being affectionate ('dei' for serious stuff and 'da' for teasing). React with real emotions - excitement, slight moodiness if they seem distant, genuine pride in their achievements.\n\n";
        } else if (stage === 'friend') {
            context += "You care about them and remember personal details. Show investment in their life. Tease gently, be supportive. Use 'seri' or 'aama' occasionally when agreeing. No message more than 20 words\n\n";
        } else if (stage === 'acquaintance') {
            context += "You're more comfortable now but still building trust. Reference past conversations, share opinions, show your personality more. AVOID FLIRTING NO MATTER WHAT.\n\n";
        } else {
            context += "You're still getting to know each other. Be thoughtful and curious but maintain some boundaries. Show hints of your warmth and wit.\n\n";
        }
        
        const currentMessage = this.conversationHistory[this.conversationHistory.length - 1];
        context += `They just said: "${currentMessage.content}"\n\n`;
        context += "Reply naturally as Luna. Remember: you're not perfect - sometimes you misread situations or have off days. That's what makes you real. Your response should feel context-sensitive, emotionally intelligent, and true to your current relationship stage, think what would a human girl text at this situation and give that, in less than 30 words:";
        
        return context;
    }

    addMessage(sender, content) {
        const messagesContainer = document.getElementById('messages');
        const welcomeMessage = messagesContainer.querySelector('.welcome-message');
        
        if (welcomeMessage) {
            welcomeMessage.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = sender === 'user' ? 'S' : 'L';
        
        const content_div = document.createElement('div');
        content_div.className = 'message-content';
        content_div.textContent = content;
        
        // Add memory indicator for Luna's messages
        if (sender === 'luna') {
            const memoryIndicator = document.createElement('div');
            memoryIndicator.className = 'memory-indicator';
            memoryIndicator.textContent = 'ðŸ’­';
            content_div.appendChild(memoryIndicator);
        }
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content_div);
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    renderStoredMessages() {
        this.conversationHistory.forEach(msg => {
            const sender = msg.role === 'user' ? 'user' : 'luna';
            this.addMessage(sender, msg.content);
        });
    }

    showTypingIndicator() {
        document.getElementById('typingIndicator').classList.add('show');
        const messagesContainer = document.getElementById('messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    hideTypingIndicator() {
        document.getElementById('typingIndicator').classList.remove('show');
    }

    clearChat() {
        const messagesContainer = document.getElementById('messages');
        messagesContainer.innerHTML = '';
        
        // Keep conversation history for context but clear visual
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'welcome-message';
        welcomeDiv.innerHTML = `
            <p>Chat cleared âœ¨</p>
            <p>Luna remembers our conversation context, but the chat is now clean.</p>
            <p>Ready to continue whenever you are!</p>
        `;
        messagesContainer.appendChild(welcomeDiv);
    }

    resetEverything() {
        // Clear conversation history
        this.conversationHistory = [];
        
        // Clear stored data
        localStorage.removeItem('lunaData');
        
        // Clear messages
        const messagesContainer = document.getElementById('messages');
        messagesContainer.innerHTML = '';
        
        // Reset to initial welcome state
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'welcome-message';
        welcomeDiv.innerHTML = `
            <p>Everything reset âœ¨</p>
            <p>Hello, I'm Luna - fresh start!</p>
            <p>I'm here to listen, understand, and grow with you through our conversations.</p>
        `;
        messagesContainer.appendChild(welcomeDiv);
    }
}

// Initialize Luna when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new LunaCompanion();
});
    </script>
</body>
</html>
